{{define "content"}}
<br>
<br>
<br>

<div class="row">
    <div class="col-md-6">
        <h2>Cron Jobs Status</h2>
        <canvas id="cronChart" width="600" height="300"></canvas>
    </div>
    <div class="col-md-6">
        <h2>Enqueued Jobs Status</h2>
        <canvas id="enqueuedChart" width="600" height="300"></canvas>
    </div>

</div>


<script>
    let cronChart, enqueuedChart;

    const statusColors = {
        "queued": "rgba(23, 162, 184, 0.7)",       // bg-info
        "processing": "rgba(0, 123, 255, 0.7)",    // bg-primary
        "succeeded": "rgba(40, 167, 69, 0.7)",     // bg-success
        "failed": "rgba(220, 53, 69, 0.7)",        // bg-danger
        "retrying": "rgba(255, 193, 7, 0.7)",      // bg-warning
        "dead": "rgba(52, 58, 64, 0.7)",           // bg-dark
        "unknown": "rgba(248, 249, 250, 0.7)"      // bg-light
    };

    function extractChartData(statusMap) {
        const labels = [];
        const values = [];
        const colors = [];

        for (const [status, count] of Object.entries(statusMap)) {
            labels.push(status);
            values.push(count);
            const color = statusColors[status.toLowerCase()] || statusColors["unknown"];
            colors.push(color);
        }

        return { labels, values, colors };
    }

    function createChart(ctxId, label, statusMap) {
        const ctx = document.getElementById(ctxId).getContext('2d');
        const { labels, values, colors } = extractChartData(statusMap);

        return new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: values,
                    backgroundColor: colors
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        precision: 0
                    }
                }
            }
        });
    }

    function updateCharts() {
        fetch('/charts?loadCharts=true')
            .then(res => res.json())
            .then(data => {
                const cron = data.cron_jobs;
                const enqueued = data.enqueued_jobs;

                if (!cronChart || !enqueuedChart) {
                    cronChart = createChart('cronChart', 'Cron Jobs', cron);
                    enqueuedChart = createChart('enqueuedChart', 'Enqueued Jobs', enqueued);
                } else {
                    const cronData = extractChartData(cron);
                    cronChart.data.labels = cronData.labels;
                    cronChart.data.datasets[0].data = cronData.values;
                    cronChart.data.datasets[0].backgroundColor = cronData.colors;
                    cronChart.update();

                    const enqData = extractChartData(enqueued);
                    enqueuedChart.data.labels = enqData.labels;
                    enqueuedChart.data.datasets[0].data = enqData.values;
                    enqueuedChart.data.datasets[0].backgroundColor = enqData.colors;
                    enqueuedChart.update();
                }

                pulseChart('cronChart');
                pulseChart('enqueuedChart');
            })
            .catch(err => console.error('Fetch error:', err));
    }


    function pulseChart(id) {
        const el = document.getElementById(id);
        el.classList.remove('pulse');
        void el.offsetWidth;
        el.classList.add('pulse');
    }

    updateCharts();

    setInterval(updateCharts, 3000);
</script>
{{ end }}